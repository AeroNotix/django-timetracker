
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>timetracker.utils.calendar_utils &mdash; Timetracker 1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Timetracker 1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Timetracker 1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for timetracker.utils.calendar_utils</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for collecting the utility functions dealing with mostly calendar</span>
<span class="sd">tasks, processing dates and creating time-based code.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">calendar</span> <span class="kn">as</span> <span class="nn">cdr</span>

<span class="kn">from</span> <span class="nn">django.core.handlers.wsgi</span> <span class="kn">import</span> <span class="n">WSGIRequest</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">send_mail</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">IntegrityError</span>
<span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">ValidationError</span>

<span class="kn">import</span> <span class="nn">simplejson</span>

<span class="kn">from</span> <span class="nn">timetracker.loggers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">debug_log</span><span class="p">,</span> <span class="n">info_log</span><span class="p">,</span>
                                 <span class="n">email_log</span><span class="p">,</span> <span class="n">database_log</span><span class="p">,</span>
                                 <span class="n">error_log</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">timetracker.tracker.models</span> <span class="kn">import</span> <span class="n">TrackingEntry</span><span class="p">,</span> <span class="n">Tbluser</span>
<span class="kn">from</span> <span class="nn">timetracker.tracker.models</span> <span class="kn">import</span> <span class="n">Tblauthorization</span> <span class="k">as</span> <span class="n">Tblauth</span>
<span class="kn">from</span> <span class="nn">timetracker.utils.error_codes</span> <span class="kn">import</span> <span class="n">DUPLICATE_ENTRY</span><span class="p">,</span> <span class="n">CONNECTION_REFUSED</span>
<span class="kn">from</span> <span class="nn">timetracker.utils.datemaps</span> <span class="kn">import</span> <span class="p">(</span><span class="n">MONTH_MAP</span><span class="p">,</span> <span class="n">WEEK_MAP_SHORT</span><span class="p">,</span>
                                        <span class="n">generate_select</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">timetracker.utils.decorators</span> <span class="kn">import</span> <span class="p">(</span><span class="n">admin_check</span><span class="p">,</span> <span class="n">json_response</span><span class="p">,</span>
                                          <span class="n">request_check</span><span class="p">)</span>



<div class="viewcode-block" id="get_request_data"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.get_request_data">[docs]</a><span class="k">def</span> <span class="nf">get_request_data</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a form and a request object we pull out</span>
<span class="sd">    from the request what the form defines.</span>

<span class="sd">    i.e.</span>

<span class="sd">    .. codeblock python::</span>
<span class="sd">    form = {</span>
<span class="sd">        &#39;data1&#39;: None</span>
<span class="sd">    }</span>

<span class="sd">    get_request_data(form, request) will then fill</span>
<span class="sd">    that data with what&#39;s in the request object.</span>

<span class="sd">    :param form: A dictionary of items which should be filled from...</span>
<span class="sd">    :param request: The request object where the data should be taken from.</span>
<span class="sd">    :returns: A dictionary which contains the actual data from the request.</span>
<span class="sd">    :rtype: :class:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c"># get our form data</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c"># get the user id from the session</span>
    <span class="n">data</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">data</span>

</div>
<div class="viewcode-block" id="validate_time"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.validate_time">[docs]</a><span class="k">def</span> <span class="nf">validate_time</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validates the times given</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shour</span><span class="p">,</span> <span class="n">sminute</span> <span class="o">=</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">ehour</span><span class="p">,</span> <span class="n">eminute</span> <span class="o">=</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">shour</span><span class="p">,</span> <span class="n">sminute</span><span class="p">)</span>
            <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">ehour</span><span class="p">,</span> <span class="n">eminute</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="parse_time"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.parse_time">[docs]</a><span class="k">def</span> <span class="nf">parse_time</span><span class="p">(</span><span class="n">timestring</span><span class="p">,</span> <span class="n">type_of</span><span class="o">=</span><span class="nb">int</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a time string will return a tuple of ints,</span>
<span class="sd">    i.e. &quot;09:44&quot; returns [9, 44] with the default args,</span>
<span class="sd">    you can pass any function to the type argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">type_of</span><span class="p">,</span> <span class="n">timestring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="calendar_wrapper"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.calendar_wrapper">[docs]</a><span class="k">def</span> <span class="nf">calendar_wrapper</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator which checks if the calendar function was</span>
<span class="sd">    called as an ajax request or not, if so, then the</span>
<span class="sd">    the wrapper constructs the arguments for the call</span>
<span class="sd">    from the POST items</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks argument length and constructs the call</span>
<span class="sd">        based on that.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">WSGIRequest</span><span class="p">):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">eeid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;eeid&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s">&#39;calendar&#39;</span><span class="p">:</span> <span class="n">function</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">eeid</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_dict</span><span class="p">))</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># if the function was called from a view</span>
            <span class="c"># let it just do it&#39;s thing</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span>

</div>
<div class="viewcode-block" id="gen_holiday_list"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.gen_holiday_list">[docs]</a><span class="k">def</span> <span class="nf">gen_holiday_list</span><span class="p">(</span><span class="n">admin_user</span><span class="p">,</span>
                     <span class="n">year</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                     <span class="n">month</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Outputs a holiday calendar for that month.</span>

<span class="sd">    For each user we get their tracking entries,</span>
<span class="sd">    then iterate over each of their entries</span>
<span class="sd">    checking if it is a holiday or not, if it is</span>
<span class="sd">    then we change the class entry for that number</span>
<span class="sd">    in the day class&#39; dict.</span>

<span class="sd">    Adds a submit button along with passing the</span>
<span class="sd">    user_id to it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># we convert the arguments to ints because</span>
    <span class="c"># we get given unicode objects</span>
    <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>

    <span class="n">str_output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_out</span> <span class="o">=</span> <span class="n">str_output</span><span class="o">.</span><span class="n">append</span>
    <span class="n">to_out</span><span class="p">(</span><span class="s">&#39;&lt;table year=</span><span class="si">%s</span><span class="s"> month=</span><span class="si">%s</span><span class="s"> id=&quot;holiday-table&quot;&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">))</span>
    <span class="n">to_out</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;tr&gt;</span>
<span class="s">                 &lt;th align=&quot;centre&quot; colspan=&quot;100&quot;&gt;{0}&lt;/th&gt;</span>
<span class="s">              &lt;/tr&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MONTH_MAP</span><span class="p">[</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c"># generate the calendar,</span>
    <span class="n">datetime_cal</span> <span class="o">=</span> <span class="n">gen_datetime_cal</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>

    <span class="c"># get just the days for the td text</span>
    <span class="n">calendar_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">day</span><span class="o">.</span><span class="n">day</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">datetime_cal</span><span class="p">]</span>

    <span class="c"># generate the top row, with day names</span>
    <span class="n">day_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">WEEK_MAP_SHORT</span><span class="p">[</span><span class="n">day</span><span class="o">.</span><span class="n">weekday</span><span class="p">()]</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">datetime_cal</span><span class="p">]</span>
    <span class="n">to_out</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;tr id=&quot;theader&quot;&gt;&lt;td&gt;Name&lt;/td&gt;&lt;td&gt;Balance&lt;/td&gt;&lt;td&gt;Code&lt;/td&gt;&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">to_out</span><span class="p">(</span><span class="s">&quot;&lt;td&gt;</span><span class="si">%s</span><span class="s">&lt;/td&gt;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">day_names</span><span class="p">]</span>
    <span class="n">to_out</span><span class="p">(</span><span class="s">&quot;&lt;/tr&gt;&quot;</span><span class="p">)</span>

    <span class="c"># here we add the administrator to their list of employees</span>
    <span class="c"># this means that administrator accounts can view/change</span>
    <span class="c"># their own holidays</span>
    <span class="n">auth_user</span> <span class="o">=</span> <span class="n">Tblauth</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">admin</span><span class="o">=</span><span class="n">admin_user</span><span class="o">.</span><span class="n">get_administrator</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">admin_user</span><span class="o">.</span><span class="n">user_type</span> <span class="o">==</span> <span class="s">&quot;TEAML&quot;</span><span class="p">:</span>
        <span class="n">user_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">auth_user</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">admin_user</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">auth_user</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_list</span><span class="p">:</span>
        <span class="n">day_classes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">num</span><span class="p">:</span> <span class="s">&#39;empty&#39;</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">calendar_array</span>
        <span class="p">}</span>

        <span class="c"># We have a dict with each day as currently</span>
        <span class="c"># empty, we iterate through the tracking</span>
        <span class="c"># entries and apply the daytype from that.</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">tracking_entries</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
            <span class="n">day_classes</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">entry_date</span><span class="o">.</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">daytype</span>

        <span class="c"># output the table row title, which contains:-</span>
        <span class="c"># Full name, Holiday Balance and the User&#39;s</span>
        <span class="c"># job code.</span>
        <span class="n">to_out</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">               &lt;tr&gt;</span>
<span class="s">                 &lt;th class=&quot;user-td&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/th&gt;</span>
<span class="s">                   &lt;td&gt;</span><span class="si">%s</span><span class="s">&lt;/td&gt;</span>
<span class="s">                   &lt;td class=&quot;job_code&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/td&gt;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
            <span class="n">user</span><span class="o">.</span><span class="n">get_holiday_balance</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
            <span class="n">user</span><span class="o">.</span><span class="n">job_code</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c"># We&#39;ve mapped the users&#39; days to the day number,</span>
        <span class="c"># we can write the user_id as an attribute to the</span>
        <span class="c"># table data and also the dayclass for styling,</span>
        <span class="c"># also, the current day number so that the table</span>
        <span class="c"># shows what number we&#39;re on.</span>
        <span class="k">for</span> <span class="n">klass</span><span class="p">,</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">day_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">to_out</span><span class="p">(</span><span class="s">&#39;&lt;td usrid=</span><span class="si">%s</span><span class="s"> class=</span><span class="si">%s</span><span class="s">&gt;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">klass</span><span class="p">))</span>

        <span class="c"># user_id is added as attr to make mass calls</span>
        <span class="n">to_out</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;td&gt;</span>
<span class="s">                    &lt;input value=&quot;submit&quot; type=&quot;button&quot; user_id=&quot;{0}&quot;</span>
<span class="s">                           onclick=&quot;submit_holidays({0})&quot; /&gt;</span>
<span class="s">                  &lt;/td&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">to_out</span><span class="p">(</span><span class="s">&#39;&lt;/tr&gt;&#39;</span><span class="p">)</span>

    <span class="c"># generate the data for the year select box</span>
    <span class="n">year_select_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">year</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">year_select_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)])</span>
    <span class="n">year_select_data</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c"># generate the data for the month select box</span>
    <span class="n">month_select_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">month_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                         <span class="k">for</span> <span class="n">month_num</span><span class="p">,</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">MONTH_MAP</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="c"># generate the select box for the years</span>
    <span class="n">year_select</span> <span class="o">=</span> <span class="n">generate_select</span><span class="p">(</span><span class="n">year_select_data</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;year_select&quot;</span><span class="p">)</span>
    <span class="c"># generate the selecte box for the months</span>
    <span class="n">month_select</span> <span class="o">=</span> <span class="n">generate_select</span><span class="p">(</span><span class="n">month_select_data</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;month_select&quot;</span><span class="p">)</span>
    <span class="c"># generate submit all button</span>
    <span class="n">to_out</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    &lt;tr&gt;</span>
<span class="s">      &lt;td colspan=&quot;100&quot; align=&quot;right&quot;&gt;</span>
<span class="s">        &lt;input id=&quot;btn_change_td&quot; value=&quot;Reload&quot;</span>
<span class="s">               type=&quot;button&quot;</span>
<span class="s">               onclick=&quot;change_table_data()&quot; /&gt;</span>
<span class="s">          {0} {1}</span>
<span class="s">        &lt;input id=&quot;submit_all&quot; value=&quot;Submit All&quot;</span>
<span class="s">               type=&quot;button&quot;</span>
<span class="s">               onclick=&quot;submit_all()&quot; /&gt;</span>
<span class="s">      &lt;/td&gt;</span>
<span class="s">     &lt;/tr&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year_select</span><span class="p">,</span> <span class="n">month_select</span><span class="p">))</span>

    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_output</span><span class="p">)</span>

</div>
<span class="nd">@calendar_wrapper</span>
<div class="viewcode-block" id="gen_calendar"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.gen_calendar">[docs]</a><span class="k">def</span> <span class="nf">gen_calendar</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                 <span class="n">month</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                 <span class="n">day</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                 <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a HTML calendar, calling a database user to get their day-by-day</span>
<span class="sd">    entries and gives each day a special CSS class so that days can be styled</span>
<span class="sd">    individually.</span>

<span class="sd">    The generated HTML should be &#39;pretty printed&#39; as well, so the output code</span>
<span class="sd">    should be pretty readable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># django passes us Unicode strings</span>
    <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">month</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MONTH_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">Http404</span>

    <span class="c"># if we&#39;ve generated December, link to the next year</span>
    <span class="k">if</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="s">&#39;&quot;/calendar/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="s">&#39;&quot;/calendar/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c"># if we&#39;ve generated January, link to the previous year</span>
    <span class="k">if</span> <span class="n">month</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">previous_url</span> <span class="o">=</span> <span class="s">&#39;&quot;/calendar/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">previous_url</span> <span class="o">=</span> <span class="s">&#39;&quot;/calendar/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c"># user_id came from sessions or the ajax call</span>
    <span class="c"># so this is pretty safe</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id__exact</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

    <span class="c"># pull out the entries for the given month</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">TrackingEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">database</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">entry_date__year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
            <span class="n">entry_date__month</span><span class="o">=</span><span class="n">month</span>
            <span class="p">)</span>

    <span class="k">except</span> <span class="n">TrackingEntry</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="c"># it seems Django still follows through with the assignment</span>
        <span class="c"># when it raises an error, this is actually quite good because</span>
        <span class="c"># we can treat the query set like normal</span>
        <span class="k">pass</span>

    <span class="c"># create a semi-sparsely populated n-dimensional</span>
    <span class="c"># array with the month&#39;s days per week</span>
    <span class="n">calendar_array</span> <span class="o">=</span> <span class="n">cdr</span><span class="o">.</span><span class="n">monthcalendar</span><span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c"># creating a list holder for the strings</span>
    <span class="c"># this is faster than concatenating the</span>
    <span class="c"># strings as we go.</span>
    <span class="n">cal_html</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">to_cal</span> <span class="o">=</span> <span class="n">cal_html</span><span class="o">.</span><span class="n">append</span>

    <span class="c"># create the table header</span>
    <span class="n">to_cal</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;table id=&quot;calendar&quot; border=&quot;1&quot;&gt;</span><span class="se">\n\t\t\t</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">to_cal</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;tr&gt;</span>
<span class="s">                &lt;td class=&quot;table-header&quot; colspan=&quot;2&quot;&gt;</span>
<span class="s">                  &lt;a class=&quot;table-links&quot; href={0}&gt;&amp;lt;&lt;/a&gt;</span>
<span class="s">                &lt;/td&gt;</span>

<span class="s">                &lt;td class=&quot;table-header&quot; colspan=&quot;3&quot;&gt;{2}&lt;/td&gt;</span>

<span class="s">                &lt;td class=&quot;table-header&quot; colspan=&quot;2&quot;&gt;</span>
<span class="s">                  &lt;a class=&quot;table-links&quot; href={1}&gt;&amp;gt;&lt;/a&gt;</span>
<span class="s">                &lt;/td&gt;</span>
<span class="s">              &lt;/tr&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">previous_url</span><span class="p">,</span>
                                <span class="n">next_url</span><span class="p">,</span>
                                <span class="n">MONTH_MAP</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span>
           <span class="p">)</span>

    <span class="c"># insert day names</span>
    <span class="n">to_cal</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\n\t\t\t</span><span class="s">&lt;tr&gt;</span>
<span class="s">                &lt;td class=day-names&gt;Mon&lt;/td&gt;</span>
<span class="s">                &lt;td class=day-names&gt;Tue&lt;/td&gt;</span>
<span class="s">                &lt;td class=day-names&gt;Wed&lt;/td&gt;</span>
<span class="s">                &lt;td class=day-names&gt;Thu&lt;/td&gt;</span>
<span class="s">                &lt;td class=day-names&gt;Fri&lt;/td&gt;</span>
<span class="s">                &lt;td class=day-names&gt;Sat&lt;/td&gt;</span>
<span class="s">                &lt;td class=day-names&gt;Sun&lt;/td&gt;</span>
<span class="s">              &lt;/tr&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c"># each row in the calendar_array is a week</span>
    <span class="c"># in the calendar, so create a new row</span>
    <span class="k">for</span> <span class="n">week_</span> <span class="ow">in</span> <span class="n">calendar_array</span><span class="p">:</span>
        <span class="n">to_cal</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\n\t\t\t</span><span class="s">&lt;tr&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_day</span> <span class="ow">in</span> <span class="n">week_</span><span class="p">:</span>

            <span class="c"># the calendar_array fills extraneous days</span>
            <span class="c"># with 0&#39;s, we can catch that and treat either</span>
            <span class="c"># end of the calendar differently in the CSS</span>
            <span class="k">if</span> <span class="n">_day</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">emptyclass</span> <span class="o">=</span> <span class="s">&#39;day-class empty-day&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">emptyclass</span> <span class="o">=</span> <span class="s">&#39;empty&#39;</span>

            <span class="c"># we&#39;ve got the month in the query set,</span>
            <span class="c"># so just query that set for individual days</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># get all the data from our in-memory query-set.</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entry_date__day</span><span class="o">=</span><span class="n">_day</span><span class="p">)</span>

                <span class="c"># Pass these to the page so that the jQuery functions</span>
                <span class="c"># get the function arguments to edit those elements</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">start_time</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">end_time</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">entry_date</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">daytype</span><span class="p">,</span>
                    <span class="n">_day</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">breaks</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">breaks</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
                    <span class="p">]</span>

                <span class="n">to_cal</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t\t\t</span><span class="s"></span>
<span class="s">                       &lt;td onclick=&quot;toggleChangeEntries({0}, {1}, &#39;{2}&#39;,</span>
<span class="s">                                                        {3}, {4}, &#39;{5}&#39;,</span>
<span class="s">                                                        &#39;{6}&#39;, &#39;{7}&#39;, {9},</span>
<span class="s">                                                        {10}, &#39;{11}&#39;)&quot;</span>
<span class="s">                           class=&quot;day-class {7}&quot;&gt;{8}&lt;/td&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">)</span>
                       <span class="p">)</span>

            <span class="k">except</span> <span class="n">TrackingEntry</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>

                <span class="c"># For clicking blank days to input the day quickly into the</span>
                <span class="c"># box. An alternative to the datepicker</span>
                <span class="k">if</span> <span class="n">_day</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">entry_date_string</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span>
                                                     <span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">_day</span><span class="p">]</span>
                                                     <span class="p">)</span>
                                                <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">entry_date_string</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

                <span class="c"># we don&#39;t want to write a 0 in the box</span>
                <span class="n">_day</span> <span class="o">=</span> <span class="s">&#39;&amp;nbsp&#39;</span> <span class="k">if</span> <span class="n">_day</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">_day</span>

                <span class="c"># write in the box and give the empty boxes a way to clear</span>
                <span class="c"># the form</span>
                <span class="n">to_cal</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t\t\t</span><span class="s">&lt;td onclick=&quot;hideEntries(&#39;{0}&#39;)&quot;</span>
<span class="s">                    class=&quot;{1}&quot;&gt;{2}&lt;/td&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                  <span class="n">entry_date_string</span><span class="p">,</span>
                                                  <span class="n">emptyclass</span><span class="p">,</span>
                                                  <span class="n">_day</span><span class="p">)</span>
                                              <span class="p">)</span>

        <span class="c"># close up that row</span>
        <span class="n">to_cal</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\t\t\t</span><span class="s">&lt;/tr&gt;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c"># close up the table</span>
    <span class="n">to_cal</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">&lt;/table&gt;&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c"># join up the html and push it back</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cal_html</span><span class="p">)</span>

</div>
<span class="nd">@request_check</span>
<span class="nd">@json_response</span>
<div class="viewcode-block" id="ajax_add_entry"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.ajax_add_entry">[docs]</a><span class="k">def</span> <span class="nf">ajax_add_entry</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Adds a calendar entry asynchronously</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># object to dump form data into</span>
    <span class="n">form</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;entry_date&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;start_time&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;end_time&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;daytype&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;breaks&#39;</span><span class="p">:</span> <span class="bp">None</span>
    <span class="p">}</span>

    <span class="c"># get the form data from the request object</span>
    <span class="n">form</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_request_data</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>

    <span class="c"># create objects to put our data into</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># server-side time validation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_time</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;start_time&#39;</span><span class="p">],</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;end_time&#39;</span><span class="p">]):</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Start time after end time&quot;</span>
            <span class="k">return</span> <span class="n">json_data</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">error_log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Date error got through - </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;start_time&#39;</span><span class="p">],</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;end_time&#39;</span><span class="p">]))</span>
        <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Date Error&quot;</span>
        <span class="k">return</span> <span class="n">json_data</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">TrackingEntry</span><span class="p">(</span><span class="o">**</span><span class="n">form</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">DUPLICATE_ENTRY</span><span class="p">:</span>
            <span class="n">database_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Duplicate entry from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">])</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;There is a duplicate entry for this value&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json_data</span>

    <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span>
                           <span class="n">form</span><span class="p">[</span><span class="s">&#39;entry_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)</span>
                           <span class="p">)</span>

    <span class="n">calendar</span> <span class="o">=</span> <span class="n">gen_calendar</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span>
                            <span class="n">form</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">])</span>

    <span class="c"># if all went well</span>
    <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;calendar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calendar</span>
    <span class="k">return</span> <span class="n">json_data</span>

</div>
<span class="nd">@request_check</span>
<span class="nd">@json_response</span>
<div class="viewcode-block" id="ajax_delete_entry"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.ajax_delete_entry">[docs]</a><span class="k">def</span> <span class="nf">ajax_delete_entry</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously deletes an entry</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;hidden-id&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;entry_date&#39;</span><span class="p">:</span> <span class="bp">None</span>
    <span class="p">}</span>

    <span class="c"># get the form data from the request object</span>
    <span class="n">form</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_request_data</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>

    <span class="c"># create our json structure</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;hidden-id&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># get the user and make sure that the user</span>
            <span class="c"># assigned to the TrackingEntry is the same</span>
            <span class="c"># as what&#39;s requesting the deletion</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id__exact</span><span class="o">=</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">])</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">TrackingEntry</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;hidden-id&#39;</span><span class="p">],</span>
                                  <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">error_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json_data</span>

    <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span>
                           <span class="n">form</span><span class="p">[</span><span class="s">&#39;entry_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)</span>
                           <span class="p">)</span>

    <span class="n">calendar</span> <span class="o">=</span> <span class="n">gen_calendar</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span>
                            <span class="n">user</span><span class="o">=</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">])</span>

    <span class="c"># if all went well</span>
    <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;calendar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calendar</span>
    <span class="k">return</span> <span class="n">json_data</span>

</div>
<span class="nd">@json_response</span>
<div class="viewcode-block" id="ajax_error"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.ajax_error">[docs]</a><span class="k">def</span> <span class="nf">ajax_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a HttpResponse with JSON as a payload with the error</span>
<span class="sd">    code as the string that the function is called with</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="n">error</span>
        <span class="p">}</span>

</div>
<span class="nd">@request_check</span>
<span class="nd">@json_response</span>
<div class="viewcode-block" id="ajax_change_entry"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.ajax_change_entry">[docs]</a><span class="k">def</span> <span class="nf">ajax_change_entry</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Changes a calendar entry asynchronously</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># object to dump form data into</span>
    <span class="n">form</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;entry_date&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;start_time&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;end_time&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;daytype&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;breaks&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;hidden-id&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c"># get the form data from the request object</span>
    <span class="n">form</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_request_data</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>

    <span class="c"># create objects to put our data into</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># server-side time validation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_time</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;start_time&#39;</span><span class="p">],</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;end_time&#39;</span><span class="p">]):</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Start time after end time&quot;</span>
            <span class="k">return</span> <span class="n">json_data</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">error_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Date error got through - </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;start_time&#39;</span><span class="p">],</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;end_time&#39;</span><span class="p">]))</span>
        <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Date Error&quot;</span>
        <span class="k">return</span> <span class="n">json_data</span>

    <span class="k">if</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;hidden-id&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># get the user and make sure that the user</span>
            <span class="c"># assigned to the TrackingEntry is the same</span>
            <span class="c"># as what&#39;s requesting the change</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id__exact</span><span class="o">=</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">])</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">TrackingEntry</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;hidden-id&#39;</span><span class="p">],</span>
                                  <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

            <span class="c"># change the fields on the retrieved entry</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">entry_date</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;entry_date&#39;</span><span class="p">]</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;start_time&#39;</span><span class="p">]</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;end_time&#39;</span><span class="p">]</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">daytype</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;daytype&#39;</span><span class="p">]</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">breaks</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="s">&#39;breaks&#39;</span><span class="p">]</span>

            <span class="n">entry</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">error_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json_data</span>

    <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span>
                           <span class="n">form</span><span class="p">[</span><span class="s">&#39;entry_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)</span>
                           <span class="p">)</span>

    <span class="n">calendar</span> <span class="o">=</span> <span class="n">gen_calendar</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span>
                            <span class="n">form</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">])</span>

    <span class="c"># if all went well</span>
    <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;calendar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calendar</span>
    <span class="k">return</span> <span class="n">json_data</span>

</div>
<span class="nd">@request_check</span>
<span class="nd">@admin_check</span>
<span class="nd">@json_response</span>
<div class="viewcode-block" id="get_user_data"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.get_user_data">[docs]</a><span class="k">def</span> <span class="nf">get_user_data</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a user as a json object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">id__exact</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>

        <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
            <span class="s">&#39;firstname&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">firstname</span><span class="p">,</span>
            <span class="s">&#39;lastname&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">lastname</span><span class="p">,</span>
            <span class="s">&#39;market&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">market</span><span class="p">,</span>
            <span class="s">&#39;process&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">process</span><span class="p">,</span>
            <span class="s">&#39;user_type&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">user_type</span><span class="p">,</span>
            <span class="s">&#39;start_date&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">start_date</span><span class="p">),</span>
            <span class="s">&#39;breaklength&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">breaklength</span><span class="p">),</span>
            <span class="s">&#39;shiftlength&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">shiftlength</span><span class="p">),</span>
            <span class="s">&#39;job_code&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">job_code</span><span class="p">,</span>
            <span class="s">&#39;holiday_balance&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">holiday_balance</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">json_data</span>

</div>
<span class="nd">@request_check</span>
<span class="nd">@admin_check</span>
<span class="nd">@json_response</span>
<div class="viewcode-block" id="delete_user"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.delete_user">[docs]</a><span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously deletes a user</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">error_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Tried to delete non-existant user&quot;</span><span class="p">)</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;User does not exist&quot;</span>
            <span class="k">return</span> <span class="n">json_data</span>

        <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">json_data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Missing user&quot;</span>
    <span class="k">return</span> <span class="n">json_data</span>

</div>
<span class="nd">@request_check</span>
<span class="nd">@admin_check</span>
<span class="nd">@json_response</span>
<div class="viewcode-block" id="useredit"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.useredit">[docs]</a><span class="k">def</span> <span class="nf">useredit</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a user to the database asynchronously</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># create a random enough password</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">91</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>

    <span class="c"># get the data off the request object</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;form_type&quot;</span><span class="p">,</span> <span class="s">&quot;mode&quot;</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
    <span class="p">}</span>

    <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;false&quot;</span><span class="p">:</span>
            <span class="c"># create the user</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Tbluser</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c"># link the user to the admin</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># get the user object from the database</span>
                <span class="n">auth_user</span> <span class="o">=</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">session_id</span><span class="p">)</span>

                <span class="c"># if the user is a team leader, they don&#39;t have</span>
                <span class="c"># table auth instances assigned to them, their</span>
                <span class="c"># manager is the one with the table auth, but</span>
                <span class="c"># the TEAML is assigned the same team.</span>
                <span class="k">if</span> <span class="n">auth_user</span><span class="o">.</span><span class="n">user_type</span> <span class="o">==</span> <span class="s">&quot;TEAML&quot;</span><span class="p">:</span>

                    <span class="c"># we find the Tblauth instance with the TEAML user</span>
                    <span class="c"># assigned to it, so we can pull that team</span>
                    <span class="n">auth_user</span> <span class="o">=</span> <span class="n">Tblauth</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">users</span><span class="o">=</span><span class="n">session_id</span><span class="p">)</span><span class="o">.</span><span class="n">admin</span>

                <span class="c"># Now we have the user with the auth table, get their instance</span>
                <span class="n">auth</span> <span class="o">=</span> <span class="n">Tblauth</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">admin</span><span class="o">=</span><span class="n">auth_user</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Tblauth</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="n">auth</span> <span class="o">=</span> <span class="n">Tblauth</span><span class="p">(</span>
                    <span class="n">admin</span><span class="o">=</span><span class="n">Tbluser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">session_id</span><span class="p">))</span>
                <span class="n">auth</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">auth</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">auth</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">email_message</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">                Hi {0},</span>
<span class="s">                </span><span class="se">\t</span><span class="s">Your account has been created with the timetracker.</span>
<span class="s">                Please use the following password to login: {1}.</span><span class="se">\n</span><span class="s"></span>
<span class="s">                Regards,</span>
<span class="s">                {2}</span>
<span class="s">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">firstname</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">auth_user</span><span class="o">.</span><span class="n">firstname</span><span class="p">)</span>

            <span class="n">send_mail</span><span class="p">(</span><span class="s">&#39;Your account has been created&#39;</span><span class="p">,</span>
                      <span class="n">email_message</span><span class="p">,</span>
                      <span class="s">&#39;timetracker@unmonitored.com&#39;</span><span class="p">,</span>
                      <span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">],</span>
                      <span class="n">fail_silently</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If the mode contains a user_id</span>
            <span class="c"># get that user and update it&#39;s</span>
            <span class="c"># attributes with what was on the form</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id__exact</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;mode&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s">&#39;password&#39;</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">DUPLICATE_ENTRY</span><span class="p">:</span>
            <span class="n">database_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Duplicate entry - </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Duplicate entry&quot;</span>
            <span class="k">return</span> <span class="n">json_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">database_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json_data</span>
    <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
        <span class="n">error_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Invalid data in creating a user&quot;</span><span class="p">)</span>
        <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Invalid Data.&quot;</span>
        <span class="k">return</span> <span class="n">json_data</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONNECTION_REFUSED</span><span class="p">:</span>
            <span class="n">email_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;email failed to send to </span><span class="si">%s</span><span class="s"> with manager </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">auth</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="n">error_log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">json_data</span>
    <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">json_data</span>

</div>
<span class="nd">@request_check</span>
<span class="nd">@admin_check</span>
<span class="nd">@json_response</span>
<div class="viewcode-block" id="mass_holidays"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.mass_holidays">[docs]</a><span class="k">def</span> <span class="nf">mass_holidays</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a holidays for a specific user en masse</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
    <span class="p">}</span>

    <span class="n">form_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;year&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;month&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;user_id&#39;</span><span class="p">:</span> <span class="bp">None</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">form_data</span><span class="p">:</span>
        <span class="n">form_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">holiday_data</span> <span class="o">=</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;holiday_data&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">holiday_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="c"># conversion to int-&gt;str removes newlines easier</span>
        <span class="n">day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s">&#39;year&#39;</span><span class="p">]</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="s">&#39;month&#39;</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;empty&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">removal_entry</span> <span class="o">=</span> <span class="n">TrackingEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">entry_date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">form_data</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="n">removal_entry</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">TrackingEntry</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                because we&#39;re sending all data</span>
<span class="sd">                with each ajax request, we delete</span>
<span class="sd">                ones that are in the database, but</span>
<span class="sd">                not in the ajax data, therefore,</span>
<span class="sd">                if we get a DoesNotExist it just</span>
<span class="sd">                means that we don&#39;t need to do</span>
<span class="sd">                anything</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># mass uploads are non-working days</span>
                <span class="c"># so the admin doesn&#39;t need to assign</span>
                <span class="c"># tonnes of time data to each entry</span>
                <span class="n">time_str</span> <span class="o">=</span> <span class="s">&quot;00:00:00&quot;</span>
                <span class="n">new_entry</span> <span class="o">=</span> <span class="n">TrackingEntry</span><span class="p">(</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">form_data</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">],</span>
                    <span class="n">entry_date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
                    <span class="n">start_time</span><span class="o">=</span><span class="n">time_str</span><span class="p">,</span>
                    <span class="n">end_time</span><span class="o">=</span><span class="n">time_str</span><span class="p">,</span>
                    <span class="n">breaks</span><span class="o">=</span><span class="n">time_str</span><span class="p">,</span>
                    <span class="n">daytype</span><span class="o">=</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="n">new_entry</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                if we find that it&#39;s an existant</span>
<span class="sd">                entry, it means that we&#39;re in change</span>
<span class="sd">                mode, so assign the new daytype and save</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">DUPLICATE_ENTRY</span><span class="p">:</span>
                    <span class="n">change_entry</span> <span class="o">=</span> <span class="n">TrackingEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">user_id</span><span class="o">=</span><span class="n">form_data</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">],</span>
                        <span class="n">entry_date</span><span class="o">=</span><span class="n">date</span>
                        <span class="p">)</span>
                    <span class="n">change_entry</span><span class="o">.</span><span class="n">daytype</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">change_entry</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># if we&#39;re here, something real bad has happened</span>
                    <span class="c"># don&#39;t send this error to the user</span>
                    <span class="n">error_log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="c"># I know this is bad but, we can&#39;t allow errors to bubble</span>
                <span class="n">error_log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
                <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">json_data</span>
    <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">json_data</span>

</div>
<span class="nd">@request_check</span>
<span class="nd">@json_response</span>
<div class="viewcode-block" id="profile_edit"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.profile_edit">[docs]</a><span class="k">def</span> <span class="nf">profile_edit</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously edits a user&#39;s profile</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;success&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># get the user object from the db</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;user_id&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">Tbluser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">error_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Editing a non-existant user&quot;</span><span class="p">)</span>
        <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;User not found&quot;</span>
        <span class="k">return</span> <span class="n">json_data</span>

    <span class="c"># pull the data out the form</span>
    <span class="n">form_data</span> <span class="o">=</span> <span class="n">get_request_data</span><span class="p">({</span>
        <span class="s">&#39;firstname&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;lastname&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="bp">None</span>
        <span class="p">},</span> <span class="n">request</span><span class="p">)</span>
    <span class="c"># get request data also pulls out the user_id,</span>
    <span class="c"># we don&#39;t need it</span>
    <span class="n">form_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;user_id&quot;</span><span class="p">)</span>

    <span class="c"># get the items from the form and save them onto the</span>
    <span class="c"># user object</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">form_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">json_data</span>

</div>
<div class="viewcode-block" id="gen_datetime_cal"><a class="viewcode-back" href="../../../timetracker.html#timetracker.utils.calendar_utils.gen_datetime_cal">[docs]</a><span class="k">def</span> <span class="nf">gen_datetime_cal</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generates a datetime list of all days in a month</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span>
    <span class="n">days</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">week</span> <span class="ow">in</span> <span class="n">cdr</span><span class="o">.</span><span class="n">monthcalendar</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
        <span class="n">days</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">week</span><span class="p">)</span>
    <span class="n">days</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">((</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">days</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">days</span><span class="p">]</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Timetracker 1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Aaron France.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>